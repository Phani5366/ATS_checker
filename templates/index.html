<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillSync AI - ATS Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }

        /* Animated Background Blobs */
        .blob {
            position: absolute;
            filter: blur(50px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #ff7eb3; animation-delay: 0s; border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        .blob-2 { bottom: -10%; right: -10%; width: 450px; height: 450px; background: #7afcff; animation-delay: 2s; border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        .blob-3 { top: 40%; left: 30%; width: 300px; height: 300px; background: #feff9c; animation-delay: 4s; border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(30px, -50px) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            border-radius: 24px;
            transition: transform 0.3s ease;
        }
        
        /* Interactive Elements */
        .bounce-hover:hover { animation: bounce-slight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite alternate; }
        @keyframes bounce-slight { from { transform: translateY(0); } to { transform: translateY(-6px); } }

        .btn-gradient {
            background: linear-gradient(45deg, #FF512F 0%, #DD2476 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(221, 36, 118, 0.4);
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.5) 10px, rgba(255,255,255,0.5) 20px);
        }
        .drop-zone.active {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        /* Circular Progress */
        .circle-chart {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            max-height: 200px;
        }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            transition: stroke-dasharray 1.5s ease-out, stroke 0.3s ease;
        }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Hidden Classes */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader Animation */
        .scanner {
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, transparent, #6366f1, transparent);
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 1.5s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Markdown-ish content styling */
        .analysis-content ul { list-style-type: none; padding-left: 0; margin-top: 0.5rem; }
        .analysis-content li { 
            margin-bottom: 0.5rem; 
            padding-left: 1.5rem; 
            position: relative; 
            line-height: 1.5;
        }
        .analysis-content li::before {
            content: "â€¢";
            position: absolute;
            left: 0.5rem;
            color: currentColor;
            opacity: 0.7;
        }
        .analysis-content strong {
            font-weight: 800;
            color: #1f2937;
            background: rgba(255,255,255,0.5);
            padding: 0 4px;
            border-radius: 4px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="selection:bg-pink-300 selection:text-pink-900">

    <!-- Background Shapes -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    
    <!-- Confetti Layer -->
    <canvas id="confetti-canvas"></canvas>

    <!-- Main Container -->
    <div class="container max-w-4xl mx-auto relative z-10">
        
        <!-- Header -->
        <div class="text-center mb-8 transform hover:scale-105 transition-transform duration-300 cursor-default">
            <h1 class="text-5xl font-extrabold text-white drop-shadow-lg mb-2 flex justify-center items-center gap-3">
                <i data-lucide="zap" class="w-10 h-10 text-yellow-300 animate-pulse"></i>
                SkillSync AI
                <i data-lucide="zap" class="w-10 h-10 text-yellow-300 animate-pulse"></i>
            </h1>
            <p class="text-white text-xl opacity-90 font-semibold">Align your resume with your dream job instantly.</p>
        </div>

        <!-- App Card -->
        <div class="glass-card p-8 md:p-10">
            
            <!-- Step 1: Input Form -->
            <div id="input-section" class="fade-in">
                <form id="upload-form" onsubmit="event.preventDefault(); startAnalysis();">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Job Description Column -->
                        <div class="space-y-4">
                            <label class="block text-indigo-900 font-bold text-lg flex items-center gap-2">
                                <i data-lucide="briefcase" class="w-5 h-5"></i>
                                Job Description
                            </label>
                            <div class="relative group">
                                <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
                                <textarea id="job-desc" name="job_description"
                                    class="relative w-full h-64 p-4 rounded-xl border-none ring-2 ring-indigo-100 focus:ring-4 focus:ring-indigo-300 outline-none resize-none text-gray-700 bg-white/80 shadow-inner transition-all"
                                    placeholder="Paste the job requirements here..."></textarea>
                            </div>
                        </div>

                        <!-- Resume Upload Column -->
                        <div class="space-y-4 flex flex-col">
                            <label class="block text-indigo-900 font-bold text-lg flex items-center gap-2">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                                Your Resume
                            </label>
                            <div id="drop-zone" class="drop-zone flex-1 rounded-xl flex flex-col items-center justify-center p-8 cursor-pointer relative overflow-hidden group">
                                <!-- Input is z-10 so clicking anywhere triggers upload by default -->
                                <input type="file" id="file-input" name="resume" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".pdf,.doc,.docx,.txt">
                                
                                <div id="upload-content" class="text-center transition-all duration-300 group-hover:scale-110">
                                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-200 transition-colors">
                                        <i data-lucide="upload-cloud" class="w-10 h-10 text-indigo-600"></i>
                                    </div>
                                    <p class="text-indigo-900 font-bold text-lg">Drag & Drop PDF</p>
                                    <p class="text-indigo-500 text-sm">or click to browse</p>
                                </div>

                                <!-- Success State (Hidden by default) -->
                                <div id="file-success" class="hidden text-center relative z-20">
                                    <!-- Pointer events none on container so clicks pass through to input for re-uploading via background area if needed, 
                                         but button needs pointer-events-auto -->
                                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce pointer-events-none">
                                        <i data-lucide="check-circle-2" class="w-10 h-10 text-green-600"></i>
                                    </div>
                                    <p id="filename-display" class="text-green-800 font-bold truncate max-w-[200px] mx-auto pointer-events-none">resume.pdf</p>
                                    <p class="text-green-600 text-xs mb-3 pointer-events-none">Ready to scan!</p>
                                    
                                    <!-- Remove Button: z-20 and relative to sit above the file input -->
                                    <button type="button" onclick="removeFile(event)" class="text-red-500 hover:text-white hover:bg-red-500 bg-white text-xs font-bold py-1.5 px-4 rounded-full border border-red-200 shadow-sm transition-all flex items-center justify-center gap-1 mx-auto relative cursor-pointer">
                                        <i data-lucide="x" class="w-3 h-3"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analyze Button -->
                    <div class="mt-8 flex justify-center">
                        <button type="submit" class="btn-gradient text-white font-bold py-4 px-12 rounded-full shadow-xl flex items-center gap-3 text-xl group relative overflow-hidden">
                            <span class="relative z-10">Sync & Score</span>
                            <i data-lucide="rocket" class="w-6 h-6 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform relative z-10"></i>
                            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Processing (Hidden) -->
            <div id="processing-section" class="hidden text-center py-12">
                <div class="relative w-48 h-64 mx-auto bg-white rounded-lg shadow-xl overflow-hidden mb-6 border border-gray-200">
                    <div class="p-4 space-y-2 opacity-50">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                        <div class="h-20 bg-gray-100 rounded w-full mt-4"></div>
                    </div>
                    <div class="scanner"></div>
                </div>
                <h3 class="text-2xl font-bold text-indigo-900 mb-2">Syncing Skills...</h3>
                <p id="loading-text" class="text-indigo-600">Analyzing keyword density...</p>
            </div>

            <!-- Step 3: Results (Hidden) -->
            <div id="results-section" class="hidden fade-in">
                
                <div class="flex flex-col items-center gap-8">
                    
                    <!-- Top: Score Chart -->
                    <div class="w-full flex flex-col items-center justify-center relative transform hover:scale-105 transition-transform duration-500">
                        <svg viewBox="0 0 36 36" class="circle-chart w-48 h-48 transform -rotate-90">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="score-circle" class="circle" stroke-dasharray="0, 100" stroke="#4f46e5" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-gray-400 font-bold text-sm uppercase tracking-widest">Score</span>
                            <span id="score-number" class="text-5xl font-extrabold text-indigo-700">0%</span>
                        </div>
                        <h2 id="verdict-title" class="text-2xl font-bold text-gray-800 mt-4 animate-bounce">
                            <!-- Dynamic Verdict -->
                        </h2>
                    </div>

                    <!-- Middle: Side by Side Grid -->
                    <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Card 1: Matching Skills -->
                        <div class="bg-green-50/80 rounded-2xl p-6 border border-green-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-3 mb-4 border-b border-green-200 pb-2">
                                <div class="bg-green-100 p-2 rounded-lg">
                                    <i data-lucide="check-circle" class="text-green-600 w-6 h-6"></i>
                                </div>
                                <h3 class="font-bold text-green-900 text-lg">Matching Skills</h3>
                            </div>
                            <div id="matching-container">
                                <ul class="text-green-800 text-sm analysis-content">
                                    <!-- Dynamic Content -->
                                </ul>
                            </div>
                        </div>

                        <!-- Card 2: Missing Skills -->
                        <div class="bg-red-50/80 rounded-2xl p-6 border border-red-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-3 mb-4 border-b border-red-200 pb-2">
                                <div class="bg-red-100 p-2 rounded-lg">
                                    <i data-lucide="alert-triangle" class="text-red-600 w-6 h-6"></i>
                                </div>
                                <h3 class="font-bold text-red-900 text-lg">Missing Skills</h3>
                            </div>
                            <div id="missing-container">
                                <ul class="text-red-800 text-sm analysis-content">
                                    <!-- Dynamic Content -->
                                </ul>
                            </div>
                        </div>

                    </div>

                    <!-- Bottom: Verdict/Summary -->
                    <div class="w-full bg-blue-50/80 rounded-2xl p-6 border border-blue-200 shadow-sm">
                        <div class="flex items-center gap-3 mb-4 border-b border-blue-200 pb-2">
                            <div class="bg-blue-100 p-2 rounded-lg">
                                <i data-lucide="file-bar-chart-2" class="text-blue-600 w-6 h-6"></i>
                            </div>
                            <h3 class="font-bold text-blue-900 text-lg">Analysis Summary</h3>
                        </div>
                        <div id="verdict-container">
                            <ul class="text-blue-800 text-sm analysis-content">
                                <!-- Dynamic Content -->
                            </ul>
                        </div>
                    </div>

                    <!-- Gemini AI Tools Section -->
                    <div class="w-full mt-6">
                        <h3 class="text-xl font-bold text-white mb-4 text-center drop-shadow-md">âœ¨ AI Power Tools</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="fetchCoverLetter()" class="bg-white/90 hover:bg-white text-indigo-600 font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all hover:scale-105 group">
                                <span class="bg-indigo-100 p-2 rounded-lg group-hover:bg-indigo-200 transition-colors">
                                    <i data-lucide="pen-tool" class="w-6 h-6 text-indigo-600"></i>
                                </span>
                                <span>Generate Cover Letter</span>
                            </button>
                            <button onclick="fetchInterviewPrep()" class="bg-white/90 hover:bg-white text-purple-600 font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all hover:scale-105 group">
                                <span class="bg-purple-100 p-2 rounded-lg group-hover:bg-purple-200 transition-colors">
                                    <i data-lucide="mic-2" class="w-6 h-6 text-purple-600"></i>
                                </span>
                                <span>Interview Prep Questions</span>
                            </button>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <button onclick="resetApp()" class="text-indigo-100 font-semibold hover:text-white flex items-center justify-center gap-2 transition-colors px-6 py-2 rounded-full hover:bg-white/10 mx-auto">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Scan New Resume
                        </button>
                    </div>

                </div>
            </div>

        </div>
        
        <p class="text-center text-white/70 mt-6 text-sm">
            SkillSync AI Demo | Powered by Gemini
        </p>
    </div>

    <!-- Universal Modal -->
    <div id="ai-modal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="modal-content-box">
            
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-purple-50 rounded-t-2xl">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <!-- Dynamic Title -->
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <div id="modal-loader" class="hidden flex flex-col items-center justify-center py-12">
                    <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                    <p class="text-indigo-600 font-semibold animate-pulse">Consulting Gemini AI...</p>
                </div>
                <div id="modal-body" class="prose prose-indigo max-w-none text-gray-700 whitespace-pre-line">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-2xl">
                <button onclick="copyModalContent()" class="text-indigo-600 font-bold hover:bg-indigo-50 px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy Text
                </button>
                <button onclick="closeModal()" class="bg-indigo-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadContent = document.getElementById('upload-content');
        const fileSuccess = document.getElementById('file-success');
        const filenameDisplay = document.getElementById('filename-display');
        const jobDesc = document.getElementById('job-desc');
        
        const inputSection = document.getElementById('input-section');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');
        const loadingText = document.getElementById('loading-text');

        // State for AI Features
        let currentAnalysisData = {
            resumeText: "", 
            parsedResume: "",
            parsedJobDesc: ""
        };

        // Drag & Drop Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('active');
        }

        function unhighlight(e) {
            dropZone.classList.remove('active');
        }

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                uploadContent.classList.add('hidden');
                fileSuccess.classList.remove('hidden');
                filenameDisplay.textContent = file.name;
                
                dropZone.classList.add('border-green-400', 'bg-green-50/50');
            }
        }
        
        function removeFile(e) {
            // Stop propagation to prevent opening the file dialog via the parent label/input
            e.stopPropagation(); 
            e.preventDefault();
            
            // Clear input
            fileInput.value = "";
            
            // Reset UI
            fileSuccess.classList.add('hidden');
            uploadContent.classList.remove('hidden');
            dropZone.classList.remove('border-green-400', 'bg-green-50/50');
        }

        // --- Analysis Logic ---
        async function startAnalysis() {
            if (!fileInput.files.length) {
                shakeButton();
                alert("Please upload a resume PDF! ðŸ“„");
                return;
            }
            if (!jobDesc.value.trim()) {
                shakeButton();
                alert("Please paste the job description! ðŸ’¼");
                return;
            }

            inputSection.classList.add('hidden');
            processingSection.classList.remove('hidden');

            const funnyMessages = [
                "Feeding data to the algorithm goblins...",
                "Measuring buzzword density...",
                "Calculating synergy levels...",
                "Consulting the hiring oracle...",
                "Parsing your destiny..."
            ];
            let msgIndex = 0;
            const msgInterval = setInterval(() => {
                loadingText.textContent = funnyMessages[msgIndex];
                msgIndex = (msgIndex + 1) % funnyMessages.length;
            }, 800);

            const formData = new FormData();
            formData.append('resume', fileInput.files[0]);
            formData.append('job_description', jobDesc.value);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Server error");

                const data = await response.json();
                
                // Store data for AI features
                currentAnalysisData.parsedResume = data.parsed_resume;
                currentAnalysisData.parsedJobDesc = data.parsed_job_description;

                clearInterval(msgInterval);
                processResults(data.ats_result);

            } catch (error) {
                clearInterval(msgInterval);
                console.error(error);
                alert("Oops! Something went wrong. Make sure the backend is running.");
                resetApp();
            }
        }

        function processResults(textResult) {
            processingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            const scoreMatch = textResult.match(/percentage.*?(\d{1,3})/i);
            const score = scoreMatch ? parseInt(scoreMatch[1]) : 0;

            const sections = {
                matching: extractSection(textResult, "Matching skills", "Missing skills"),
                missing: extractSection(textResult, "Missing skills", "Strengths"),
                verdict: extractSection(textResult, "Strengths", "Improvement suggestions")
            };

            animateScore(score);
            renderFeedback(sections);
        }

        function extractSection(text, startPhrase, endPhrase) {
            const lowerText = text.toLowerCase();
            const start = lowerText.indexOf(startPhrase.toLowerCase());
            if (start === -1) return "No specific details found.";
            
            const effectiveStart = start + startPhrase.length;
            let end = lowerText.indexOf(endPhrase.toLowerCase(), effectiveStart);
            if (end === -1) end = text.length; 

            let content = text.substring(effectiveStart, end).trim();
            content = content.replace(/^[:\-\.]+\s*/, '').trim();
            
            const items = content.split('\n')
                .filter(line => line.trim().length > 0)
                .slice(0, 5) 
                .map(line => {
                    let cleanLine = line.replace(/^[\-\*]\s*/, '');
                    cleanLine = cleanLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    return `<li>${cleanLine}</li>`;
                })
                .join('');
            
            return items.length > 0 ? items : "<li>No data available</li>";
        }

        function renderFeedback(sections) {
            document.querySelector('#matching-container ul').innerHTML = sections.matching;
            document.querySelector('#missing-container ul').innerHTML = sections.missing;
            document.querySelector('#verdict-container ul').innerHTML = sections.verdict;
            lucide.createIcons();
        }

        function animateScore(score) {
            const scoreCircle = document.getElementById('score-circle');
            const scoreNumber = document.getElementById('score-number');
            const verdictTitle = document.getElementById('verdict-title');

            scoreNumber.textContent = "0%";
            scoreCircle.setAttribute('stroke-dasharray', `0, 100`);

            let color = '#ef4444';
            let text = "Needs Work ðŸ˜…";
            if(score > 60) { color = '#eab308'; text = "Getting There! ðŸ˜"; }
            if(score > 80) { color = '#22c55e'; text = "Excellent Match! ðŸŽ‰"; }
            
            scoreCircle.setAttribute('stroke', color);
            verdictTitle.innerHTML = text;
            verdictTitle.style.color = color;

            setTimeout(() => {
                scoreCircle.setAttribute('stroke-dasharray', `${score}, 100`);
            }, 100);

            let currentScore = 0;
            const duration = 1500;
            const intervalTime = 20;
            const steps = duration / intervalTime;
            const increment = score / steps;

            const scoreInterval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= score) {
                    currentScore = score;
                    clearInterval(scoreInterval);
                    if (score > 80) triggerConfetti();
                }
                scoreNumber.textContent = Math.floor(currentScore) + "%";
            }, intervalTime);
        }

        function resetApp() {
            resultsSection.classList.add('hidden');
            inputSection.classList.remove('hidden');
            fileInput.value = "";
            uploadContent.classList.remove('hidden');
            fileSuccess.classList.add('hidden');
            jobDesc.value = "";
            currentAnalysisData = { parsedResume: "", parsedJobDesc: "" };
            
            // Clean up visual state of file input too
            const dropZone = document.getElementById('drop-zone');
            dropZone.classList.remove('border-green-400', 'bg-green-50/50');
        }

        function shakeButton() {
            const btn = document.querySelector('.btn-gradient');
            btn.style.animation = 'shake 0.5s';
            setTimeout(() => btn.style.animation = '', 500);
        }

        // --- AI Features Functions ---

        function openModal(title) {
            const modal = document.getElementById('ai-modal');
            const titleEl = document.getElementById('modal-title');
            const loader = document.getElementById('modal-loader');
            const body = document.getElementById('modal-body');
            const contentBox = document.getElementById('modal-content-box');

            modal.classList.remove('hidden');
            titleEl.innerHTML = title;
            loader.classList.remove('hidden');
            body.classList.add('hidden');
            body.innerHTML = '';
            
            // Animation
            setTimeout(() => {
                contentBox.classList.remove('scale-95', 'opacity-0');
                contentBox.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('ai-modal');
            const contentBox = document.getElementById('modal-content-box');
            
            contentBox.classList.remove('scale-100', 'opacity-100');
            contentBox.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function fetchCoverLetter() {
            openModal(`âœ¨ AI Cover Letter <span class="text-sm font-normal text-gray-500 ml-2">(Draft)</span>`);
            
            try {
                const response = await fetch('/cover-letter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentAnalysisData.parsedResume,
                        jd_text: currentAnalysisData.parsedJobDesc
                    })
                });
                
                const data = await response.json();
                updateModalContent(data.cover_letter);
            } catch (e) {
                updateModalContent("Error generating cover letter. Please try again.");
            }
        }

        async function fetchInterviewPrep() {
            openModal(`âœ¨ Interview Prep <span class="text-sm font-normal text-gray-500 ml-2">(Personalized)</span>`);
            
            try {
                const response = await fetch('/interview-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentAnalysisData.parsedResume,
                        jd_text: currentAnalysisData.parsedJobDesc
                    })
                });
                
                const data = await response.json();
                updateModalContent(data.questions);
            } catch (e) {
                updateModalContent("Error generating questions. Please try again.");
            }
        }

        function updateModalContent(text) {
            const loader = document.getElementById('modal-loader');
            const body = document.getElementById('modal-body');
            
            loader.classList.add('hidden');
            body.classList.remove('hidden');
            
            // Basic Markdown to HTML
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
                
            body.innerHTML = formattedText;
        }

        function copyModalContent() {
            const body = document.getElementById('modal-body');
            // Copy plain text, replacing <br> with newlines
            const textToCopy = body.innerHTML
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<strong>/g, '')
                .replace(/<\/strong>/g, '')
                .replace(/&nbsp;/g, ' ');
                
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = document.querySelector('#modal-content-box .fa-copy').parentElement;
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Copied!`;
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i> Copy Text`;
                    lucide.createIcons();
                }, 2000);
            });
        }

        // --- Confetti ---
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            
            for(let i=0; i<150; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 8 + 4,
                    speedY: Math.random() * 3 + 2,
                    speedX: Math.random() * 4 - 2,
                    color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                    rotation: Math.random() * 360,
                    rotationSpeed: Math.random() * 10 - 5
                });
            }

            function animateConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let activeParticles = 0;
                particles.forEach(p => {
                    p.y += p.speedY;
                    p.x += p.speedX;
                    p.rotation += p.rotationSpeed;
                    
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();
                    
                    if (p.y < canvas.height) activeParticles++;
                });
                if (activeParticles > 0) requestAnimationFrame(animateConfetti);
            }
            animateConfetti();
        }

        // Add shake animation styles
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes shake {
                0% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                50% { transform: translateX(10px); }
                75% { transform: translateX(-10px); }
                100% { transform: translateX(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>